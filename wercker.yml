box: akiko/docker-for-redmine-plugin-test
build:
  steps:
    - script:
        name: ready redmine source code
        code: |
          sh ./script/redmine-ready.sh
    - script:
        name: check directory again
        code: |
          pwd
          ls -la .
          ls -la plugins/${PLUGIN_NAME}
    - bundle-install:
        path: vendor/bundle
        without: mysql postgreql rmagick
    - script:
        name: 'Bundle Update'
        code: |
          bundle update
    - script:
        name: 'Migrate DB'
        code:
          bundle exec rake db:migrate RAILS_ENV=test
    - script:
        name: 'Migrate Plugin'
        code:
          bundle exec rake redmine:plugins:migrate RAILS_ENV=test
    - script:
        name: 'Run Plugin tests via rake task'
        code: |
          bundle exec rake ${PLUGIN_NAME}:test
    - script:
        name: 'Run Plugin spec'
        code: |
          bundle exec rspec -I plugins/${PLUGIN_NAME}/spec --format documentation plugins/${PLUGIN_NAME}/spec/
    - script:
        name: 'Uninstall Schema tests'
        code: |
          bundle exec rake redmine:plugins:migrate NAME=${PLUGIN_NAME} VERSION=0 RAILS_ENV=test
    - script:
        name: 'store coverage report'
        code: |
          cp -r coverage ${WERCKER_REPORT_ARTIFACTS_DIR}/
